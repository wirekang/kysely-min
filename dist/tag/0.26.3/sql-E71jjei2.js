function isUndefined(e){return void 0===e||void 0===e}function isString(e){return"string"==typeof e}function isNumber(e){return"number"==typeof e}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isDate(e){return e instanceof Date}function isBigInt(e){return"bigint"==typeof e}function isBuffer(e){return"undefined"!=typeof Buffer&&Buffer.isBuffer(e)}function isFunction(e){return"function"==typeof e}function isObject(e){return"object"==typeof e&&null!==e}function isPlainObject(e){return isObject(e)&&!Array.isArray(e)&&!isDate(e)&&!isBuffer(e)&&!function isArrayBufferOrView(e){return e instanceof ArrayBuffer||ArrayBuffer.isView(e)}(e)}function getLast(e){return e[e.length-1]}function freeze(e){return Object.freeze(e)}function isReadonlyArray(e){return Array.isArray(e)}function noop(e){return e}function compare(e,r){return isReadonlyArray(e)&&isReadonlyArray(r)?function compareArrays(e,r){if(e.length!==r.length)return!1;for(let t=0;t<e.length;++t)if(!compare(e[t],r[t]))return!1;return!0}(e,r):isObject(e)&&isObject(r)?function compareObjects(e,r){if(isBuffer(e)&&isBuffer(r))return function compareBuffers(e,r){return 0===Buffer.compare(e,r)}(e,r);if(isDate(e)&&isDate(r))return function compareDates(e,r){return e.getTime()===r.getTime()}(e,r);return function compareGenericObjects(e,r){const t=Object.keys(e),n=Object.keys(r);if(t.length!==n.length)return!1;for(const n of t)if(!compare(e[n],r[n]))return!1;return!0}(e,r)}(e,r):e===r}const e=freeze({is:e=>"IdentifierNode"===e.kind,create:e=>freeze({kind:"IdentifierNode",name:e})}),r=freeze({is:e=>"SchemableIdentifierNode"===e.kind,create:r=>freeze({kind:"SchemableIdentifierNode",identifier:e.create(r)}),createWithSchema:(r,t)=>freeze({kind:"SchemableIdentifierNode",schema:e.create(r),identifier:e.create(t)})}),t=freeze({is:e=>"AliasNode"===e.kind,create:(e,r)=>freeze({kind:"AliasNode",node:e,alias:r})}),n=freeze({is:e=>"TableNode"===e.kind,create:e=>freeze({kind:"TableNode",table:r.create(e)}),createWithSchema:(e,t)=>freeze({kind:"TableNode",table:r.createWithSchema(e,t)})});function isOperationNodeSource(e){return isObject(e)&&isFunction(e.toOperationNode)}function isExpression(e){return isObject(e)&&"expressionType"in e&&isOperationNodeSource(e)}function isAliasedExpression(e){return isObject(e)&&"expression"in e&&isString(e.alias)&&isOperationNodeSource(e)}const i=freeze({is:e=>"SelectModifierNode"===e.kind,create:e=>freeze({kind:"SelectModifierNode",modifier:e}),createWithExpression:e=>freeze({kind:"SelectModifierNode",rawModifier:e})}),o=freeze({is:e=>"AndNode"===e.kind,create:(e,r)=>freeze({kind:"AndNode",left:e,right:r})}),s=freeze({is:e=>"OrNode"===e.kind,create:(e,r)=>freeze({kind:"OrNode",left:e,right:r})}),a=freeze({is:e=>"OnNode"===e.kind,create:e=>freeze({kind:"OnNode",on:e}),cloneWithOperation:(e,r,t)=>freeze({...e,on:"And"===r?o.create(e.on,t):s.create(e.on,t)})}),d=freeze({is:e=>"JoinNode"===e.kind,create:(e,r)=>freeze({kind:"JoinNode",joinType:e,table:r,on:void 0}),createWithOn:(e,r,t)=>freeze({kind:"JoinNode",joinType:e,table:r,on:a.create(t)}),cloneWithOn:(e,r)=>freeze({...e,on:e.on?a.cloneWithOperation(e.on,"And",r):a.create(r)})}),u=freeze({is:e=>"BinaryOperationNode"===e.kind,create:(e,r,t)=>freeze({kind:"BinaryOperationNode",leftOperand:e,operator:r,rightOperand:t})}),p=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","&&","?","?&","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp"],l=["+","-","*","/","%","^","&","|","#","<<",">>"],c=["->","->>"],h=[...p,...l,"&&","||"],f=["exists","not exists"],m=["not","-",...f],N=[...h,...c,...m,"between","between symmetric"],y=freeze({is:e=>"OperatorNode"===e.kind,create:e=>freeze({kind:"OperatorNode",operator:e})});function isOperator(e){return isString(e)&&N.includes(e)}function isBinaryOperator(e){return isString(e)&&h.includes(e)}function isComparisonOperator(e){return isString(e)&&p.includes(e)}function isArithmeticOperator(e){return isString(e)&&l.includes(e)}function isJSONOperator(e){return isString(e)&&c.includes(e)}const w=freeze({is:e=>"ColumnNode"===e.kind,create:r=>freeze({kind:"ColumnNode",column:e.create(r)})}),O=freeze({is:e=>"SelectAllNode"===e.kind,create:()=>freeze({kind:"SelectAllNode"})}),B=freeze({is:e=>"ReferenceNode"===e.kind,create:(e,r)=>freeze({kind:"ReferenceNode",table:r,column:e}),createSelectAll:e=>freeze({kind:"ReferenceNode",table:e,column:O.create()})});class DynamicReferenceBuilder{#e;get dynamicReference(){return this.#e}get refType(){}constructor(e){this.#e=e}toOperationNode(){return parseSimpleReferenceExpression(this.#e)}}function isDynamicReferenceBuilder(e){return isObject(e)&&isOperationNodeSource(e)&&isString(e.dynamicReference)}const g=freeze({is:e=>"OrderByItemNode"===e.kind,create:(e,r)=>freeze({kind:"OrderByItemNode",orderBy:e,direction:r})}),x=freeze({is:e=>"RawNode"===e.kind,create:(e,r)=>freeze({kind:"RawNode",sqlFragments:freeze(e),parameters:freeze(r)}),createWithSql:e=>x.create([e],[]),createWithChild:e=>x.create(["",""],[e]),createWithChildren:e=>x.create(new Array(e.length+1).fill(""),e)});function isOrderByDirection(e){return"asc"===e||"desc"===e}function parseOrderBy(e){if(2===e.length)return[parseOrderByItem(e[0],e[1])];if(1===e.length){const[r]=e;return Array.isArray(r)?r.map((e=>parseOrderByItem(e))):[parseOrderByItem(r)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${e.length}`)}function parseOrderByItem(e,r){const t=function parseOrderByExpression(e){if(isExpressionOrFactory(e))return parseExpression(e);if(isDynamicReferenceBuilder(e))return e.toOperationNode();const[r,t]=e.split(" ");if(t){if(!isOrderByDirection(t))throw new Error(`Invalid order by direction: ${t}`);return g.create(parseStringReference(r),parseOrderByDirectionExpression(t))}return parseStringReference(e)}(e);if(g.is(t)){if(r)throw new Error("Cannot specify direction twice!");return t}return g.create(t,parseOrderByDirectionExpression(r))}function parseOrderByDirectionExpression(e){if(e)return"asc"===e||"desc"===e?x.createWithSql(e):e.toOperationNode()}const W=freeze({is:e=>"JSONReferenceNode"===e.kind,create:(e,r)=>freeze({kind:"JSONReferenceNode",reference:e,traversal:r}),cloneWithTraversal:(e,r)=>freeze({...e,traversal:r})}),S=freeze({is:e=>"JSONOperatorChainNode"===e.kind,create:e=>freeze({kind:"JSONOperatorChainNode",operator:e,values:freeze([])}),cloneWithValue:(e,r)=>freeze({...e,values:freeze([...e.values,r])})}),b=freeze({is:e=>"JSONPathNode"===e.kind,create:e=>freeze({kind:"JSONPathNode",inOperator:e,pathLegs:freeze([])}),cloneWithLeg:(e,r)=>freeze({...e,pathLegs:freeze([...e.pathLegs,r])})});function parseSimpleReferenceExpression(e){return isString(e)?parseStringReference(e):e.toOperationNode()}function parseReferenceExpressionOrList(e){return isReadonlyArray(e)?e.map((e=>parseReferenceExpression(e))):[parseReferenceExpression(e)]}function parseReferenceExpression(e){return isExpressionOrFactory(e)?parseExpression(e):parseSimpleReferenceExpression(e)}function parseStringReference(e){if(!e.includes("."))return B.create(w.create(e));const r=e.split(".").map(trim$1);if(3===r.length)return function parseStringReferenceWithTableAndSchema(e){const[r,t,i]=e;return B.create(w.create(i),n.createWithSchema(r,t))}(r);if(2===r.length)return function parseStringReferenceWithTable(e){const[r,t]=e;return B.create(w.create(t),n.create(r))}(r);throw new Error(`invalid column reference ${e}`)}function parseColumnName(e){return w.create(e)}function parseOrderedColumnName(e){if(e.includes(" ")){const[r,t]=e.split(" ").map(trim$1);if(!isOrderByDirection(t))throw new Error(`invalid order direction "${t}" next to "${r}"`);return parseOrderBy([r,t])[0]}return parseColumnName(e)}function trim$1(e){return e.trim()}const I=freeze({is:e=>"PrimitiveValueListNode"===e.kind,create:e=>freeze({kind:"PrimitiveValueListNode",values:freeze([...e])})}),z=freeze({is:e=>"ValueListNode"===e.kind,create:e=>freeze({kind:"ValueListNode",values:freeze(e)})}),E=freeze({is:e=>"ValueNode"===e.kind,create:e=>freeze({kind:"ValueNode",value:e}),createImmediate:e=>freeze({kind:"ValueNode",value:e,immediate:!0})});function parseValueExpressionOrList(e){return isReadonlyArray(e)?function parseValueExpressionList(e){if(e.some(isExpressionOrFactory))return z.create(e.map((e=>parseValueExpression(e))));return I.create(e)}(e):parseValueExpression(e)}function parseValueExpression(e){return isExpressionOrFactory(e)?parseExpression(e):E.create(e)}function isSafeImmediateValue(e){return isNumber(e)||isBoolean(e)||isNull(e)}function parseSafeImmediateValue(e){if(!isSafeImmediateValue(e))throw new Error(`unsafe immediate value ${JSON.stringify(e)}`);return E.createImmediate(e)}const C=freeze({is:e=>"ParensNode"===e.kind,create:e=>freeze({kind:"ParensNode",node:e})});function parseValueBinaryOperationOrExpression(e){if(3===e.length)return parseValueBinaryOperation(e[0],e[1],e[2]);if(1===e.length)return parseValueExpression(e[0]);throw new Error(`invalid arguments: ${JSON.stringify(e)}`)}function parseValueBinaryOperation(e,r,t){return function isIsOperator(e){return"is"===e||"is not"===e}(r)&&needsIsOperator(t)?u.create(parseReferenceExpression(e),parseOperator(r),E.createImmediate(t)):u.create(parseReferenceExpression(e),parseOperator(r),parseValueExpressionOrList(t))}function parseReferentialBinaryOperation(e,r,t){return u.create(parseReferenceExpression(e),parseOperator(r),parseReferenceExpression(t))}function parseFilterObject(e,r){return parseFilterList(Object.entries(e).filter((([,e])=>!isUndefined(e))).map((([e,r])=>parseValueBinaryOperation(e,needsIsOperator(r)?"is":"=",r))),r)}function parseFilterList(e,r){const t="and"===r?o.create:s.create;if(0===e.length)return E.createImmediate("and"===r);let n=toOperationNode(e[0]);for(let r=1;r<e.length;++r)n=t(n,toOperationNode(e[r]));return e.length>1?C.create(n):n}function needsIsOperator(e){return isNull(e)||isBoolean(e)}function parseOperator(e){if(isString(e)&&N.includes(e))return y.create(e);if(isOperationNodeSource(e))return e.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(e)}`)}function toOperationNode(e){return isOperationNodeSource(e)?e.toOperationNode():e}const k=freeze({is:e=>"OrderByNode"===e.kind,create:e=>freeze({kind:"OrderByNode",items:freeze([...e])}),cloneWithItems:(e,r)=>freeze({...e,items:freeze([...e.items,...r])})}),q=freeze({is:e=>"PartitionByNode"===e.kind,create:e=>freeze({kind:"PartitionByNode",items:freeze(e)}),cloneWithItems:(e,r)=>freeze({...e,items:freeze([...e.items,...r])})}),Q=freeze({is:e=>"OverNode"===e.kind,create:()=>freeze({kind:"OverNode"}),cloneWithOrderByItems:(e,r)=>freeze({...e,orderBy:e.orderBy?k.cloneWithItems(e.orderBy,r):k.create(r)}),cloneWithPartitionByItems:(e,r)=>freeze({...e,partitionBy:e.partitionBy?q.cloneWithItems(e.partitionBy,r):q.create(r)})}),R=freeze({is:e=>"FromNode"===e.kind,create:e=>freeze({kind:"FromNode",froms:freeze(e)}),cloneWithFroms:(e,r)=>freeze({...e,froms:freeze([...e.froms,...r])})}),T=freeze({is:e=>"GroupByNode"===e.kind,create:e=>freeze({kind:"GroupByNode",items:freeze(e)}),cloneWithItems:(e,r)=>freeze({...e,items:freeze([...e.items,...r])})}),A=freeze({is:e=>"HavingNode"===e.kind,create:e=>freeze({kind:"HavingNode",having:e}),cloneWithOperation:(e,r,t)=>freeze({...e,having:"And"===r?o.create(e.having,t):s.create(e.having,t)})}),v=freeze({is:e=>"SelectQueryNode"===e.kind,create:e=>freeze({kind:"SelectQueryNode",...e&&{with:e}}),createFrom:(e,r)=>freeze({kind:"SelectQueryNode",from:R.create(e),...r&&{with:r}}),cloneWithSelections:(e,r)=>freeze({...e,selections:e.selections?freeze([...e.selections,...r]):freeze(r)}),cloneWithDistinctOn:(e,r)=>freeze({...e,distinctOn:e.distinctOn?freeze([...e.distinctOn,...r]):freeze(r)}),cloneWithFrontModifier:(e,r)=>freeze({...e,frontModifiers:e.frontModifiers?freeze([...e.frontModifiers,r]):freeze([r])}),cloneWithEndModifier:(e,r)=>freeze({...e,endModifiers:e.endModifiers?freeze([...e.endModifiers,r]):freeze([r])}),cloneWithOrderByItems:(e,r)=>freeze({...e,orderBy:e.orderBy?k.cloneWithItems(e.orderBy,r):k.create(r)}),cloneWithGroupByItems:(e,r)=>freeze({...e,groupBy:e.groupBy?T.cloneWithItems(e.groupBy,r):T.create(r)}),cloneWithLimit:(e,r)=>freeze({...e,limit:r}),cloneWithOffset:(e,r)=>freeze({...e,offset:r}),cloneWithHaving:(e,r)=>freeze({...e,having:e.having?A.cloneWithOperation(e.having,"And",r):A.create(r)}),cloneWithSetOperations:(e,r)=>freeze({...e,setOperations:e.setOperations?freeze([...e.setOperations,...r]):freeze([...r])}),cloneWithoutSelections:e=>freeze({...e,selections:[]}),cloneWithoutLimit:e=>freeze({...e,limit:void 0}),cloneWithoutOffset:e=>freeze({...e,offset:void 0}),cloneWithoutOrderBy:e=>freeze({...e,orderBy:void 0})});function preventAwait(e,r){Object.defineProperties(e.prototype,{then:{enumerable:!1,value:()=>{throw new Error(r)}}})}class JoinBuilder{#r;constructor(e){this.#r=freeze(e)}on(...e){return new JoinBuilder({...this.#r,joinNode:d.cloneWithOn(this.#r.joinNode,parseValueBinaryOperationOrExpression(e))})}onRef(e,r,t){return new JoinBuilder({...this.#r,joinNode:d.cloneWithOn(this.#r.joinNode,parseReferentialBinaryOperation(e,r,t))})}onTrue(){return new JoinBuilder({...this.#r,joinNode:d.cloneWithOn(this.#r.joinNode,x.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return this.#r.joinNode}}preventAwait(JoinBuilder,"don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.");const D=freeze({is:e=>"PartitionByItemNode"===e.kind,create:e=>freeze({kind:"PartitionByItemNode",partitionBy:e})});function parsePartitionBy(e){return parseReferenceExpressionOrList(e).map(D.create)}class OverBuilder{#r;constructor(e){this.#r=freeze(e)}orderBy(e,r){return new OverBuilder({overNode:Q.cloneWithOrderByItems(this.#r.overNode,parseOrderBy([e,r]))})}partitionBy(e){return new OverBuilder({overNode:Q.cloneWithPartitionByItems(this.#r.overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return this.#r.overNode}}preventAwait(OverBuilder,"don't await OverBuilder instances. They are never executed directly and are always just a part of a query.");const F=freeze({is:e=>"SelectionNode"===e.kind,create:e=>freeze({kind:"SelectionNode",selection:e}),createSelectAll:()=>freeze({kind:"SelectionNode",selection:O.create()}),createSelectAllFromTable:e=>freeze({kind:"SelectionNode",selection:B.createSelectAll(e)})});function parseSelectArg(e){return isFunction(e)?parseSelectArg(e(expressionBuilder())):isReadonlyArray(e)?e.map((e=>parseSelectExpression(e))):[parseSelectExpression(e)]}function parseSelectExpression(r){return isString(r)?F.create(function parseAliasedStringReference(r){const n=" as ";if(r.includes(n)){const[i,o]=r.split(n).map(trim$1);return t.create(parseStringReference(i),e.create(o))}return parseStringReference(r)}(r)):isDynamicReferenceBuilder(r)?F.create(r.toOperationNode()):F.create(parseAliasedExpression(r))}function parseSelectAll(e){return e?Array.isArray(e)?e.map(parseSelectAllArg):[parseSelectAllArg(e)]:[F.createSelectAll()]}function parseSelectAllArg(e){if(isString(e))return F.createSelectAllFromTable(parseTable(e));throw new Error(`invalid value selectAll expression: ${JSON.stringify(e)}`)}const L=freeze({is:e=>"ValuesNode"===e.kind,create:e=>freeze({kind:"ValuesNode",values:freeze(e)})}),J=freeze({is:e=>"DefaultInsertValueNode"===e.kind,create:()=>freeze({kind:"DefaultInsertValueNode"})});function parseInsertExpression(e){const r=isFunction(e)?e(expressionBuilder()):e;return function parseInsertColumnsAndValues(e){const r=function parseColumnNamesAndIndexes(e){const r=new Map;for(const t of e){const e=Object.keys(t);for(const n of e)r.has(n)||void 0===t[n]||r.set(n,r.size)}return r}(e);return[freeze([...r.keys()].map(w.create)),L.create(e.map((e=>function parseRowValues(e,r){const t=Object.keys(e),n=Array.from({length:r.size});let i=!1;for(const o of t){const t=r.get(o);if(isUndefined(t))continue;const s=e[o];(isUndefined(s)||isExpressionOrFactory(s))&&(i=!0),n[t]=s}const o=t.length<r.size;if(o||i){const e=J.create();return z.create(n.map((r=>isUndefined(r)?e:parseValueExpression(r))))}return I.create(n)}(e,r))))]}(isReadonlyArray(r)?r:freeze([r]))}const U=freeze({is:e=>"InsertQueryNode"===e.kind,create:(e,r,t)=>freeze({kind:"InsertQueryNode",into:e,...r&&{with:r},replace:t}),cloneWith:(e,r)=>freeze({...e,...r})}),V=freeze({is:e=>"UpdateQueryNode"===e.kind,create:(e,r)=>freeze({kind:"UpdateQueryNode",table:e,...r&&{with:r}}),cloneWithFromItems:(e,r)=>freeze({...e,from:e.from?R.cloneWithFroms(e.from,r):R.create(r)}),cloneWithUpdates:(e,r)=>freeze({...e,updates:e.updates?freeze([...e.updates,...r]):r})}),P=freeze({is:e=>"UsingNode"===e.kind,create:e=>freeze({kind:"UsingNode",tables:freeze(e)}),cloneWithTables:(e,r)=>freeze({...e,tables:freeze([...e.tables,...r])})}),j=freeze({is:e=>"DeleteQueryNode"===e.kind,create:(e,r)=>freeze({kind:"DeleteQueryNode",from:R.create(e),...r&&{with:r}}),cloneWithOrderByItems:(e,r)=>freeze({...e,orderBy:e.orderBy?k.cloneWithItems(e.orderBy,r):k.create(r)}),cloneWithLimit:(e,r)=>freeze({...e,limit:r}),cloneWithUsing:(e,r)=>freeze({...e,using:void 0!==e.using?P.cloneWithTables(e.using,r):P.create(r)})}),M=freeze({is:e=>"WhereNode"===e.kind,create:e=>freeze({kind:"WhereNode",where:e}),cloneWithOperation:(e,r,t)=>freeze({...e,where:"And"===r?o.create(e.where,t):s.create(e.where,t)})}),$=freeze({is:e=>"ReturningNode"===e.kind,create:e=>freeze({kind:"ReturningNode",selections:freeze(e)}),cloneWithSelections:(e,r)=>freeze({...e,selections:e.selections?freeze([...e.selections,...r]):freeze(r)})}),K=freeze({is:e=>"ExplainNode"===e.kind,create:(e,r)=>freeze({kind:"ExplainNode",format:e,options:r})}),G=freeze({is:e=>v.is(e)||U.is(e)||V.is(e)||j.is(e),cloneWithWhere:(e,r)=>freeze({...e,where:e.where?M.cloneWithOperation(e.where,"And",r):M.create(r)}),cloneWithJoin:(e,r)=>freeze({...e,joins:e.joins?freeze([...e.joins,r]):freeze([r])}),cloneWithReturning:(e,r)=>freeze({...e,returning:e.returning?$.cloneWithSelections(e.returning,r):$.create(r)}),cloneWithoutWhere:e=>freeze({...e,where:void 0}),cloneWithExplain:(e,r,t)=>freeze({...e,explain:K.create(r,t?.toOperationNode())})}),H=freeze({is:e=>"ColumnUpdateNode"===e.kind,create:(e,r)=>freeze({kind:"ColumnUpdateNode",column:e,value:r})});function parseUpdateExpression(e){const r=isFunction(e)?e(expressionBuilder()):e;return Object.entries(r).filter((([e,r])=>void 0!==r)).map((([e,r])=>H.create(w.create(e),parseValueExpression(r))))}const X=freeze({is:e=>"OnDuplicateKeyNode"===e.kind,create:e=>freeze({kind:"OnDuplicateKeyNode",updates:e})});class InsertResult{insertId;numInsertedOrUpdatedRows;constructor(e,r){this.insertId=e,this.numInsertedOrUpdatedRows=r}}class NoResultError extends Error{node;constructor(e){super("no result"),this.node=e}}function isNoResultErrorConstructor(e){return Object.prototype.hasOwnProperty.call(e,"prototype")}const Y=freeze({is:e=>"OnConflictNode"===e.kind,create:()=>freeze({kind:"OnConflictNode"}),cloneWith:(e,r)=>freeze({...e,...r}),cloneWithIndexWhere:(e,r)=>freeze({...e,indexWhere:e.indexWhere?M.cloneWithOperation(e.indexWhere,"And",r):M.create(r)}),cloneWithIndexOrWhere:(e,r)=>freeze({...e,indexWhere:e.indexWhere?M.cloneWithOperation(e.indexWhere,"Or",r):M.create(r)}),cloneWithUpdateWhere:(e,r)=>freeze({...e,updateWhere:e.updateWhere?M.cloneWithOperation(e.updateWhere,"And",r):M.create(r)}),cloneWithUpdateOrWhere:(e,r)=>freeze({...e,updateWhere:e.updateWhere?M.cloneWithOperation(e.updateWhere,"Or",r):M.create(r)}),cloneWithoutIndexWhere:e=>freeze({...e,indexWhere:void 0}),cloneWithoutUpdateWhere:e=>freeze({...e,updateWhere:void 0})});class OnConflictBuilder{#r;constructor(e){this.#r=freeze(e)}column(e){const r=w.create(e);return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWith(this.#r.onConflictNode,{columns:this.#r.onConflictNode.columns?freeze([...this.#r.onConflictNode.columns,r]):freeze([r])})})}columns(e){const r=e.map(w.create);return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWith(this.#r.onConflictNode,{columns:this.#r.onConflictNode.columns?freeze([...this.#r.onConflictNode.columns,...r]):freeze(r)})})}constraint(r){return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWith(this.#r.onConflictNode,{constraint:e.create(r)})})}expression(e){return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWith(this.#r.onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWithIndexWhere(this.#r.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,t){return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWithIndexWhere(this.#r.onConflictNode,parseReferentialBinaryOperation(e,r,t))})}clearWhere(){return new OnConflictBuilder({...this.#r,onConflictNode:Y.cloneWithoutIndexWhere(this.#r.onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...this.#r,onConflictNode:Y.cloneWith(this.#r.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...this.#r,onConflictNode:Y.cloneWith(this.#r.onConflictNode,{updates:parseUpdateExpression(e)})})}$call(e){return e(this)}}preventAwait(OnConflictBuilder,"don't await OnConflictBuilder instances.");class OnConflictDoNothingBuilder{#r;constructor(e){this.#r=freeze(e)}toOperationNode(){return this.#r.onConflictNode}}preventAwait(OnConflictDoNothingBuilder,"don't await OnConflictDoNothingBuilder instances.");class OnConflictUpdateBuilder{#r;constructor(e){this.#r=freeze(e)}where(...e){return new OnConflictUpdateBuilder({...this.#r,onConflictNode:Y.cloneWithUpdateWhere(this.#r.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,t){return new OnConflictUpdateBuilder({...this.#r,onConflictNode:Y.cloneWithUpdateWhere(this.#r.onConflictNode,parseReferentialBinaryOperation(e,r,t))})}clearWhere(){return new OnConflictUpdateBuilder({...this.#r,onConflictNode:Y.cloneWithoutUpdateWhere(this.#r.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#r.onConflictNode}}preventAwait(OnConflictUpdateBuilder,"don't await OnConflictUpdateBuilder instances.");class InsertQueryBuilder{#r;constructor(e){this.#r=freeze(e)}values(e){const[r,t]=parseInsertExpression(e);return new InsertQueryBuilder({...this.#r,queryNode:U.cloneWith(this.#r.queryNode,{columns:r,values:t})})}columns(e){return new InsertQueryBuilder({...this.#r,queryNode:U.cloneWith(this.#r.queryNode,{columns:freeze(e.map(w.create))})})}expression(e){return new InsertQueryBuilder({...this.#r,queryNode:U.cloneWith(this.#r.queryNode,{values:parseExpression(e)})})}ignore(){return new InsertQueryBuilder({...this.#r,queryNode:U.cloneWith(this.#r.queryNode,{ignore:!0})})}onConflict(e){return new InsertQueryBuilder({...this.#r,queryNode:U.cloneWith(this.#r.queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:Y.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new InsertQueryBuilder({...this.#r,queryNode:U.cloneWith(this.#r.queryNode,{onDuplicateKey:X.create(parseUpdateExpression(e))})})}returning(e){return new InsertQueryBuilder({...this.#r,queryNode:G.cloneWithReturning(this.#r.queryNode,parseSelectArg(e))})}returningAll(){return new InsertQueryBuilder({...this.#r,queryNode:G.cloneWithReturning(this.#r.queryNode,parseSelectAll())})}$call(e){return e(this)}$if(e,r){return e?r(this):new InsertQueryBuilder({...this.#r})}$castTo(){return new InsertQueryBuilder(this.#r)}$narrowType(){return new InsertQueryBuilder(this.#r)}$assertType(){return new InsertQueryBuilder(this.#r)}withPlugin(e){return new InsertQueryBuilder({...this.#r,executor:this.#r.executor.withPlugin(e)})}toOperationNode(){return this.#r.executor.transformQuery(this.#r.queryNode,this.#r.queryId)}compile(){return this.#r.executor.compileQuery(this.toOperationNode(),this.#r.queryId)}async execute(){const e=this.compile(),r=e.query,t=await this.#r.executor.executeQuery(e,this.#r.queryId);return this.#r.executor.adapter.supportsReturning&&r.returning?t.rows:[new InsertResult(t.insertId,t.numAffectedRows??t.numUpdatedOrDeletedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(void 0===r){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return r}async*stream(e=100){const r=this.compile(),t=this.#r.executor.stream(r,e,this.#r.queryId);for await(const e of t)yield*e.rows}async explain(e,r){const t=new InsertQueryBuilder({...this.#r,queryNode:G.cloneWithExplain(this.#r.queryNode,e,r)});return await t.execute()}}preventAwait(InsertQueryBuilder,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class DeleteResult{numDeletedRows;constructor(e){this.numDeletedRows=e}}const Z=freeze({is:e=>"LimitNode"===e.kind,create:e=>freeze({kind:"LimitNode",limit:E.create(e)})});class DeleteQueryBuilder{#r;constructor(e){this.#r=freeze(e)}where(...e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithWhere(this.#r.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,t){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithWhere(this.#r.queryNode,parseReferentialBinaryOperation(e,r,t))})}clearWhere(){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithoutWhere(this.#r.queryNode)})}using(e){return new DeleteQueryBuilder({...this.#r,queryNode:j.cloneWithUsing(this.#r.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("FullJoin",e))})}returning(e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithReturning(this.#r.queryNode,parseSelectArg(e))})}returningAll(e){return new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithReturning(this.#r.queryNode,parseSelectAll(e))})}orderBy(e,r){return new DeleteQueryBuilder({...this.#r,queryNode:j.cloneWithOrderByItems(this.#r.queryNode,parseOrderBy([e,r]))})}limit(e){return new DeleteQueryBuilder({...this.#r,queryNode:j.cloneWithLimit(this.#r.queryNode,Z.create(e))})}$call(e){return e(this)}$if(e,r){return e?r(this):new DeleteQueryBuilder({...this.#r})}$castTo(){return new DeleteQueryBuilder(this.#r)}$narrowType(){return new DeleteQueryBuilder(this.#r)}$assertType(){return new DeleteQueryBuilder(this.#r)}withPlugin(e){return new DeleteQueryBuilder({...this.#r,executor:this.#r.executor.withPlugin(e)})}toOperationNode(){return this.#r.executor.transformQuery(this.#r.queryNode,this.#r.queryId)}compile(){return this.#r.executor.compileQuery(this.toOperationNode(),this.#r.queryId)}async execute(){const e=this.compile(),r=e.query,t=await this.#r.executor.executeQuery(e,this.#r.queryId);return this.#r.executor.adapter.supportsReturning&&r.returning?t.rows:[new DeleteResult(t.numAffectedRows??t.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(void 0===r){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return r}async*stream(e=100){const r=this.compile(),t=this.#r.executor.stream(r,e,this.#r.queryId);for await(const e of t)yield*e.rows}async explain(e,r){const t=new DeleteQueryBuilder({...this.#r,queryNode:G.cloneWithExplain(this.#r.queryNode,e,r)});return await t.execute()}}preventAwait(DeleteQueryBuilder,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class UpdateResult{numUpdatedRows;numChangedRows;constructor(e,r){this.numUpdatedRows=e,this.numChangedRows=r}}class UpdateQueryBuilder{#r;constructor(e){this.#r=freeze(e)}where(...e){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithWhere(this.#r.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,t){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithWhere(this.#r.queryNode,parseReferentialBinaryOperation(e,r,t))})}clearWhere(){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithoutWhere(this.#r.queryNode)})}from(e){return new UpdateQueryBuilder({...this.#r,queryNode:V.cloneWithFromItems(this.#r.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("FullJoin",e))})}set(e){return new UpdateQueryBuilder({...this.#r,queryNode:V.cloneWithUpdates(this.#r.queryNode,parseUpdateExpression(e))})}returning(e){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithReturning(this.#r.queryNode,parseSelectArg(e))})}returningAll(){return new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithReturning(this.#r.queryNode,parseSelectAll())})}$call(e){return e(this)}$if(e,r){return e?r(this):new UpdateQueryBuilder({...this.#r})}$castTo(){return new UpdateQueryBuilder(this.#r)}$narrowType(){return new UpdateQueryBuilder(this.#r)}$assertType(){return new UpdateQueryBuilder(this.#r)}withPlugin(e){return new UpdateQueryBuilder({...this.#r,executor:this.#r.executor.withPlugin(e)})}toOperationNode(){return this.#r.executor.transformQuery(this.#r.queryNode,this.#r.queryId)}compile(){return this.#r.executor.compileQuery(this.toOperationNode(),this.#r.queryId)}async execute(){const e=this.compile(),r=e.query,t=await this.#r.executor.executeQuery(e,this.#r.queryId);return this.#r.executor.adapter.supportsReturning&&r.returning?t.rows:[new UpdateResult(t.numAffectedRows??t.numUpdatedOrDeletedRows??BigInt(0),t.numChangedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(void 0===r){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return r}async*stream(e=100){const r=this.compile(),t=this.#r.executor.stream(r,e,this.#r.queryId);for await(const e of t)yield*e.rows}async explain(e,r){const t=new UpdateQueryBuilder({...this.#r,queryNode:G.cloneWithExplain(this.#r.queryNode,e,r)});return await t.execute()}}preventAwait(UpdateQueryBuilder,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const _=freeze({is:e=>"CommonTableExpressionNameNode"===e.kind,create:(e,r)=>freeze({kind:"CommonTableExpressionNameNode",table:n.create(e),columns:r?freeze(r.map(w.create)):void 0})}),ee=freeze({is:e=>"CommonTableExpressionNode"===e.kind,create:(e,r)=>freeze({kind:"CommonTableExpressionNode",name:e,expression:r}),cloneWith:(e,r)=>freeze({...e,...r})});class CTEBuilder{#r;constructor(e){this.#r=freeze(e)}materialized(){return new CTEBuilder({...this.#r,node:ee.cloneWith(this.#r.node,{materialized:!0})})}notMaterialized(){return new CTEBuilder({...this.#r,node:ee.cloneWith(this.#r.node,{materialized:!1})})}toOperationNode(){return this.#r.node}}function parseCommonTableExpression(e,r){const t=r(function createQueryCreator(){return new QueryCreator({executor:se})}()).toOperationNode();return isFunction(e)?e(function cteBuilderFactory(e){return r=>new CTEBuilder({node:ee.create(parseCommonTableExpressionName(r),e)})}(t)).toOperationNode():ee.create(parseCommonTableExpressionName(e),t)}function parseCommonTableExpressionName(e){if(e.includes("(")){const r=e.split(/[\(\)]/),t=r[0],n=r[1].split(",").map((e=>e.trim()));return _.create(t,n)}return _.create(e)}preventAwait(CTEBuilder,"don't await CTEBuilder instances. They are never executed directly and are always just a part of a query.");const re=freeze({is:e=>"WithNode"===e.kind,create:(e,r)=>freeze({kind:"WithNode",expressions:freeze([e]),...r}),cloneWithExpression:(e,r)=>freeze({...e,expressions:freeze([...e.expressions,r])})}),te=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function createQueryId(){return new LazyQueryId}class LazyQueryId{#t;get queryId(){return void 0===this.#t&&(this.#t=function randomString(e){let r="";for(let t=0;t<e;++t)r+=te[~~(Math.random()*te.length)];return r}(8)),this.#t}}class OperationNodeTransformer{nodeStack=[];#n=freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this)});transformNode(e){if(!e)return e;this.nodeStack.push(e);const r=this.transformNodeImpl(e);return this.nodeStack.pop(),freeze(r)}transformNodeImpl(e){return this.#n[e.kind](e)}transformNodeList(e){return e?freeze(e.map((e=>this.transformNode(e)))):e}transformSelectQuery(e){return{kind:"SelectQueryNode",from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations)}}transformSelection(e){return{kind:"SelectionNode",selection:this.transformNode(e.selection)}}transformColumn(e){return{kind:"ColumnNode",column:this.transformNode(e.column)}}transformAlias(e){return{kind:"AliasNode",node:this.transformNode(e.node),alias:this.transformNode(e.alias)}}transformTable(e){return{kind:"TableNode",table:this.transformNode(e.table)}}transformFrom(e){return{kind:"FromNode",froms:this.transformNodeList(e.froms)}}transformReference(e){return{kind:"ReferenceNode",column:this.transformNode(e.column),table:this.transformNode(e.table)}}transformAnd(e){return{kind:"AndNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformOr(e){return{kind:"OrNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformValueList(e){return{kind:"ValueListNode",values:this.transformNodeList(e.values)}}transformParens(e){return{kind:"ParensNode",node:this.transformNode(e.node)}}transformJoin(e){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)}}transformRaw(e){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)}}transformWhere(e){return{kind:"WhereNode",where:this.transformNode(e.where)}}transformInsertQuery(e){return{kind:"InsertQueryNode",into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain)}}transformValues(e){return{kind:"ValuesNode",values:this.transformNodeList(e.values)}}transformDeleteQuery(e){return{kind:"DeleteQueryNode",from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain)}}transformReturning(e){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections)}}transformCreateTable(e){return{kind:"CreateTableNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers)}}transformColumnDefinition(e){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers)}}transformAddColumn(e){return{kind:"AddColumnNode",column:this.transformNode(e.column)}}transformDropTable(e){return{kind:"DropTableNode",table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e){return{kind:"OrderByNode",items:this.transformNodeList(e.items)}}transformOrderByItem(e){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)}}transformGroupBy(e){return{kind:"GroupByNode",items:this.transformNodeList(e.items)}}transformGroupByItem(e){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy)}}transformUpdateQuery(e){return{kind:"UpdateQueryNode",table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),with:this.transformNode(e.with),explain:this.transformNode(e.explain)}}transformColumnUpdate(e){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column),value:this.transformNode(e.value)}}transformLimit(e){return{kind:"LimitNode",limit:this.transformNode(e.limit)}}transformOffset(e){return{kind:"OffsetNode",offset:this.transformNode(e.offset)}}transformOnConflict(e){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing}}transformOnDuplicateKey(e){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates)}}transformCreateIndex(e){return{kind:"CreateIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where)}}transformList(e){return{kind:"ListNode",items:this.transformNodeList(e.items)}}transformDropIndex(e){return{kind:"DropIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformUniqueConstraint(e){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformForeignKeyConstraint(e){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformSetOperation(e){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression),all:e.all}}transformReferences(e){return{kind:"ReferencesNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression),name:this.transformNode(e.name)}}transformWith(e){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions),recursive:e.recursive}}transformCommonTableExpression(e){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name),materialized:e.materialized,expression:this.transformNode(e.expression)}}transformCommonTableExpressionName(e){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)}}transformHaving(e){return{kind:"HavingNode",having:this.transformNode(e.having)}}transformCreateSchema(e){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists}}transformDropSchema(e){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e){return{kind:"AlterTableNode",table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint)}}transformDropColumn(e){return{kind:"DropColumnNode",column:this.transformNode(e.column)}}transformRenameColumn(e){return{kind:"RenameColumnNode",column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)}}transformAlterColumn(e){return{kind:"AlterColumnNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e){return{kind:"ModifyColumnNode",column:this.transformNode(e.column)}}transformAddConstraint(e){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint)}}transformDropConstraint(e){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier}}transformCreateView(e){return{kind:"CreateViewNode",name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)}}transformDropView(e){return{kind:"DropViewNode",name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)}}transformDefaultValue(e){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue)}}transformOn(e){return{kind:"OnNode",on:this.transformNode(e.on)}}transformSelectModifier(e){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier)}}transformCreateType(e){return{kind:"CreateTypeNode",name:this.transformNode(e.name),enum:this.transformNode(e.enum)}}transformDropType(e){return{kind:"DropTypeNode",name:this.transformNode(e.name),ifExists:e.ifExists}}transformExplain(e){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options)}}transformSchemableIdentifier(e){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)}}transformAggregateFunction(e){return{kind:"AggregateFunctionNode",aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)}}transformOver(e){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)}}transformPartitionBy(e){return{kind:"PartitionByNode",items:this.transformNodeList(e.items)}}transformPartitionByItem(e){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy)}}transformBinaryOperation(e){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)}}transformUnaryOperation(e){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)}}transformUsing(e){return{kind:"UsingNode",tables:this.transformNodeList(e.tables)}}transformFunction(e){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments)}}transformCase(e){return{kind:"CaseNode",value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement}}transformWhen(e){return{kind:"WhenNode",condition:this.transformNode(e.condition),result:this.transformNode(e.result)}}transformJSONReference(e){return{kind:"JSONReferenceNode",reference:this.transformNode(e.reference),traversal:this.transformNode(e.traversal)}}transformJSONPath(e){return{kind:"JSONPathNode",inOperator:this.transformNode(e.inOperator),pathLegs:this.transformNodeList(e.pathLegs)}}transformJSONPathLeg(e){return{kind:"JSONPathLegNode",type:e.type,value:e.value}}transformJSONOperatorChain(e){return{kind:"JSONOperatorChainNode",operator:this.transformNode(e.operator),values:this.transformNodeList(e.values)}}transformTuple(e){return{kind:"TupleNode",values:this.transformNodeList(e.values)}}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}}const ne=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0});class WithSchemaTransformer extends OperationNodeTransformer{#i;#o=new Set;#s=new Set;constructor(e){super(),this.#i=e}transformNodeImpl(e){if(!this.#a(e))return super.transformNodeImpl(e);const r=this.#d(e);for(const e of r)this.#s.add(e);const t=this.#u(e);for(const e of t)this.#o.add(e);const n=super.transformNodeImpl(e);for(const e of t)this.#o.delete(e);for(const e of r)this.#s.delete(e);return n}transformSchemableIdentifier(r){const t=super.transformSchemableIdentifier(r);return t.schema||!this.#o.has(r.identifier.name)?t:{...t,schema:e.create(this.#i)}}transformReferences(e){const r=super.transformReferences(e);return r.table.table.schema?r:{...r,table:n.createWithSchema(this.#i,r.table.table.identifier.name)}}#a(e){return e.kind in ne}#u(e){const t=new Set;if("name"in e&&e.name&&r.is(e.name)&&this.#p(e.name,t),"from"in e&&e.from)for(const r of e.from.froms)this.#l(r,t);if("into"in e&&e.into&&this.#l(e.into,t),"table"in e&&e.table&&this.#l(e.table,t),"joins"in e&&e.joins)for(const r of e.joins)this.#l(r.table,t);return t}#d(e){const r=new Set;return"with"in e&&e.with&&this.#c(e.with,r),r}#l(e,r){const i=n.is(e)?e:t.is(e)&&n.is(e.node)?e.node:null;i&&this.#p(i.table,r)}#p(e,r){const t=e.identifier.name;this.#o.has(t)||this.#s.has(t)||r.add(t)}#c(e,r){for(const t of e.expressions){const e=t.name.table.table.identifier.name;this.#s.has(e)||r.add(e)}}}class WithSchemaPlugin{#h;constructor(e){this.#h=new WithSchemaTransformer(e)}transformQuery(e){return this.#h.transformNode(e.node)}async transformResult(e){return e.result}}class QueryCreator{#r;constructor(e){this.#r=freeze(e)}selectFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#r.executor,queryNode:v.createFrom(parseTableExpressionOrList(e),this.#r.withNode)})}selectNoFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#r.executor,queryNode:v.cloneWithSelections(v.create(this.#r.withNode),parseSelectArg(e))})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#r.executor,queryNode:U.create(parseTable(e),this.#r.withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#r.executor,queryNode:U.create(parseTable(e),this.#r.withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:this.#r.executor,queryNode:j.create(parseTableExpressionOrList(e),this.#r.withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:this.#r.executor,queryNode:V.create(parseTableExpression(e),this.#r.withNode)})}with(e,r){const t=parseCommonTableExpression(e,r);return new QueryCreator({...this.#r,withNode:this.#r.withNode?re.cloneWithExpression(this.#r.withNode,t):re.create(t)})}withRecursive(e,r){const t=parseCommonTableExpression(e,r);return new QueryCreator({...this.#r,withNode:this.#r.withNode?re.cloneWithExpression(this.#r.withNode,t):re.create(t,{recursive:!0})})}withPlugin(e){return new QueryCreator({...this.#r,executor:this.#r.executor.withPlugin(e)})}withoutPlugins(){return new QueryCreator({...this.#r,executor:this.#r.executor.withoutPlugins()})}withSchema(e){return new QueryCreator({...this.#r,executor:this.#r.executor.withPluginAtFront(new WithSchemaPlugin(e))})}}class Deferred{#f;#m;#N;constructor(){this.#f=new Promise(((e,r)=>{this.#N=r,this.#m=e}))}get promise(){return this.#f}resolve=e=>{this.#m&&this.#m(e)};reject=e=>{this.#N&&this.#N(e)}}const ie=new Set;function logOnce(e){ie.has(e)||(ie.add(e),console.log(e))}const oe=freeze([]);class QueryExecutorBase{#y;constructor(e=oe){this.#y=e}get plugins(){return this.#y}transformQuery(e,r){for(const t of this.#y){const n=t.transformQuery({node:e,queryId:r});if(n.kind!==e.kind)throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${n.kind}`].join(" "));e=n}return e}async executeQuery(e,r){return await this.provideConnection((async t=>{const n=await t.executeQuery(e),i=await this.#w(n,r);return function warnOfOutdatedDriverOrPlugins(e,r){const{numAffectedRows:t}=e;if(void 0===t&&void 0===e.numUpdatedOrDeletedRows||void 0!==t&&void 0!==r.numAffectedRows)return;logOnce("kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.")}(n,i),i}))}async*stream(e,r,t){const n=new Deferred,i=new Deferred;this.provideConnection((async e=>(n.resolve(e),await i.promise))).catch((e=>n.reject(e)));const o=await n.promise;try{for await(const n of o.streamQuery(e,r))yield await this.#w(n,t)}finally{i.resolve()}}async#w(e,r){for(const t of this.#y)e=await t.transformResult({result:e,queryId:r});return e}}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const se=new NoopQueryExecutor;function parseJoin(e,r){if(3===r.length)return function parseSingleOnJoin(e,r,t,n){return d.createWithOn(e,parseTableExpression(r),parseReferentialBinaryOperation(t,"=",n))}(e,r[0],r[1],r[2]);if(2===r.length)return function parseCallbackJoin(e,r,t){return t(function createJoinBuilder(e,r){return new JoinBuilder({joinNode:d.create(e,parseTableExpression(r))})}(e,r)).toOperationNode()}(e,r[0],r[1]);throw new Error("not implemented")}const ae=freeze({is:e=>"OffsetNode"===e.kind,create:e=>freeze({kind:"OffsetNode",offset:E.create(e)})}),de=freeze({is:e=>"GroupByItemNode"===e.kind,create:e=>freeze({kind:"GroupByItemNode",groupBy:e})});function parseGroupBy(e){return parseReferenceExpressionOrList(e=isFunction(e)?e(expressionBuilder()):e).map(de.create)}const ue=freeze({is:e=>"SetOperationNode"===e.kind,create:(e,r,t)=>freeze({kind:"SetOperationNode",operator:e,expression:r,all:t})});function parseSetOperations(e,r,t){return isFunction(r)&&(r=r(createExpressionBuilder())),isReadonlyArray(r)||(r=[r]),r.map((r=>ue.create(e,parseExpression(r),t)))}class ExpressionWrapper{#O;constructor(e){this.#O=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(s.create(this.#O,parseValueBinaryOperationOrExpression(e)))}and(...e){return new AndWrapper(o.create(this.#O,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new ExpressionWrapper(this.#O)}toOperationNode(){return this.#O}}class AliasedExpressionWrapper{#B;#g;constructor(e,r){this.#B=e,this.#g=r}get expression(){return this.#B}get alias(){return this.#g}toOperationNode(){return t.create(this.#B.toOperationNode(),isOperationNodeSource(this.#g)?this.#g.toOperationNode():e.create(this.#g))}}class OrWrapper{#O;constructor(e){this.#O=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(s.create(this.#O,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new OrWrapper(this.#O)}toOperationNode(){return C.create(this.#O)}}class AndWrapper{#O;constructor(e){this.#O=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}and(...e){return new AndWrapper(o.create(this.#O,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new AndWrapper(this.#O)}toOperationNode(){return C.create(this.#O)}}class SelectQueryBuilderImpl{#r;constructor(e){this.#r=freeze(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithWhere(this.#r.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,t){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithWhere(this.#r.queryNode,parseReferentialBinaryOperation(e,r,t))})}having(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithHaving(this.#r.queryNode,parseValueBinaryOperationOrExpression(e))})}havingRef(e,r,t){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithHaving(this.#r.queryNode,parseReferentialBinaryOperation(e,r,t))})}select(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSelections(this.#r.queryNode,parseSelectArg(e))})}distinctOn(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithDistinctOn(this.#r.queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithFrontModifier(this.#r.queryNode,i.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.createWithExpression(e.toOperationNode()))})}distinct(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithFrontModifier(this.#r.queryNode,i.create("Distinct"))})}forUpdate(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.create("ForUpdate"))})}forShare(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.create("ForShare"))})}forKeyShare(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.create("ForKeyShare"))})}forNoKeyUpdate(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.create("ForNoKeyUpdate"))})}skipLocked(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.create("SkipLocked"))})}noWait(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithEndModifier(this.#r.queryNode,i.create("NoWait"))})}selectAll(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSelections(this.#r.queryNode,parseSelectAll(e))})}innerJoin(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("FullJoin",e))})}innerJoinLateral(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("LateralInnerJoin",e))})}leftJoinLateral(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithJoin(this.#r.queryNode,parseJoin("LateralLeftJoin",e))})}orderBy(...e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithOrderByItems(this.#r.queryNode,parseOrderBy(e))})}groupBy(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithGroupByItems(this.#r.queryNode,parseGroupBy(e))})}limit(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithLimit(this.#r.queryNode,Z.create(e))})}offset(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithOffset(this.#r.queryNode,ae.create(e))})}union(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSetOperations(this.#r.queryNode,parseSetOperations("union",e,!1))})}unionAll(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSetOperations(this.#r.queryNode,parseSetOperations("union",e,!0))})}intersect(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSetOperations(this.#r.queryNode,parseSetOperations("intersect",e,!1))})}intersectAll(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSetOperations(this.#r.queryNode,parseSetOperations("intersect",e,!0))})}except(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSetOperations(this.#r.queryNode,parseSetOperations("except",e,!1))})}exceptAll(e){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithSetOperations(this.#r.queryNode,parseSetOperations("except",e,!0))})}as(e){return new AliasedSelectQueryBuilderImpl(this,e)}clearSelect(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithoutSelections(this.#r.queryNode)})}clearWhere(){return new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithoutWhere(this.#r.queryNode)})}clearLimit(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithoutLimit(this.#r.queryNode)})}clearOffset(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithoutOffset(this.#r.queryNode)})}clearOrderBy(){return new SelectQueryBuilderImpl({...this.#r,queryNode:v.cloneWithoutOrderBy(this.#r.queryNode)})}$call(e){return e(this)}$if(e,r){return e?r(this):new SelectQueryBuilderImpl({...this.#r})}$castTo(){return new SelectQueryBuilderImpl(this.#r)}$narrowType(){return new SelectQueryBuilderImpl(this.#r)}$assertType(){return new SelectQueryBuilderImpl(this.#r)}$asTuple(){return new ExpressionWrapper(this.toOperationNode())}withPlugin(e){return new SelectQueryBuilderImpl({...this.#r,executor:this.#r.executor.withPlugin(e)})}toOperationNode(){return this.#r.executor.transformQuery(this.#r.queryNode,this.#r.queryId)}compile(){return this.#r.executor.compileQuery(this.toOperationNode(),this.#r.queryId)}async execute(){const e=this.compile();return(await this.#r.executor.executeQuery(e,this.#r.queryId)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(void 0===r){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return r}async*stream(e=100){const r=this.compile(),t=this.#r.executor.stream(r,e,this.#r.queryId);for await(const e of t)yield*e.rows}async explain(e,r){const t=new SelectQueryBuilderImpl({...this.#r,queryNode:G.cloneWithExplain(this.#r.queryNode,e,r)});return await t.execute()}}function createSelectQueryBuilder(e){return new SelectQueryBuilderImpl(e)}preventAwait(SelectQueryBuilderImpl,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class AliasedSelectQueryBuilderImpl{#x;#g;constructor(e,r){this.#x=e,this.#g=r}get expression(){return this.#x}get alias(){return this.#g}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return t.create(this.#x.toOperationNode(),e.create(this.#g))}}preventAwait(AliasedSelectQueryBuilderImpl,"don't await AliasedSelectQueryBuilder instances directly. AliasedSelectQueryBuilder should never be executed directly since it's always a part of another query.");const pe=freeze({is:e=>"AggregateFunctionNode"===e.kind,create:(e,r=[])=>freeze({kind:"AggregateFunctionNode",func:e,aggregated:r}),cloneWithDistinct:e=>freeze({...e,distinct:!0}),cloneWithFilter:(e,r)=>freeze({...e,filter:e.filter?M.cloneWithOperation(e.filter,"And",r):M.create(r)}),cloneWithOrFilter:(e,r)=>freeze({...e,filter:e.filter?M.cloneWithOperation(e.filter,"Or",r):M.create(r)}),cloneWithOver:(e,r)=>freeze({...e,over:r})}),le=freeze({is:e=>"FunctionNode"===e.kind,create:(e,r)=>freeze({kind:"FunctionNode",func:e,arguments:r})});class AggregateFunctionBuilder{#r;constructor(e){this.#r=freeze(e)}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new AggregateFunctionBuilder({...this.#r,aggregateFunctionNode:pe.cloneWithDistinct(this.#r.aggregateFunctionNode)})}filterWhere(...e){return new AggregateFunctionBuilder({...this.#r,aggregateFunctionNode:pe.cloneWithFilter(this.#r.aggregateFunctionNode,parseValueBinaryOperationOrExpression(e))})}filterWhereRef(e,r,t){return new AggregateFunctionBuilder({...this.#r,aggregateFunctionNode:pe.cloneWithFilter(this.#r.aggregateFunctionNode,parseReferentialBinaryOperation(e,r,t))})}over(e){const r=function createOverBuilder(){return new OverBuilder({overNode:Q.create()})}();return new AggregateFunctionBuilder({...this.#r,aggregateFunctionNode:pe.cloneWithOver(this.#r.aggregateFunctionNode,(e?e(r):r).toOperationNode())})}$call(e){return e(this)}toOperationNode(){return this.#r.aggregateFunctionNode}}preventAwait(AggregateFunctionBuilder,"don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.");class AliasedAggregateFunctionBuilder{#W;#g;constructor(e,r){this.#W=e,this.#g=r}get expression(){return this.#W}get alias(){return this.#g}toOperationNode(){return t.create(this.#W.toOperationNode(),e.create(this.#g))}}function createFunctionModule(){const fn=(e,r)=>new ExpressionWrapper(le.create(e,parseReferenceExpressionOrList(r))),agg=(e,r)=>new AggregateFunctionBuilder({aggregateFunctionNode:pe.create(e,r?parseReferenceExpressionOrList(r):void 0)});return Object.assign(fn,{agg:agg,avg:e=>agg("avg",[e]),coalesce:(e,...r)=>fn("coalesce",[e,...r]),count:e=>agg("count",[e]),countAll:e=>new AggregateFunctionBuilder({aggregateFunctionNode:pe.create("count",parseSelectAll(e))}),max:e=>agg("max",[e]),min:e=>agg("min",[e]),sum:e=>agg("sum",[e]),any:e=>fn("any",[e])})}const ce=freeze({is:e=>"UnaryOperationNode"===e.kind,create:(e,r)=>freeze({kind:"UnaryOperationNode",operator:e,operand:r})});const he=freeze({is:e=>"WhenNode"===e.kind,create:e=>freeze({kind:"WhenNode",condition:e}),cloneWithResult:(e,r)=>freeze({...e,result:r})}),fe=freeze({is:e=>"CaseNode"===e.kind,create:e=>freeze({kind:"CaseNode",value:e}),cloneWithWhen:(e,r)=>freeze({...e,when:freeze(e.when?[...e.when,r]:[r])}),cloneWithThen:(e,r)=>freeze({...e,when:e.when?freeze([...e.when.slice(0,-1),he.cloneWithResult(e.when[e.when.length-1],r)]):void 0}),cloneWith:(e,r)=>freeze({...e,...r})});class CaseBuilder{#r;constructor(e){this.#r=freeze(e)}when(...e){return new CaseThenBuilder({...this.#r,node:fe.cloneWithWhen(this.#r.node,he.create(parseValueBinaryOperationOrExpression(e)))})}}class CaseThenBuilder{#r;constructor(e){this.#r=freeze(e)}then(e){return new CaseWhenBuilder({...this.#r,node:fe.cloneWithThen(this.#r.node,isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e))})}}class CaseWhenBuilder{#r;constructor(e){this.#r=freeze(e)}when(...e){return new CaseThenBuilder({...this.#r,node:fe.cloneWithWhen(this.#r.node,he.create(parseValueBinaryOperationOrExpression(e)))})}else(e){return new CaseEndBuilder({...this.#r,node:fe.cloneWith(this.#r.node,{else:isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e)})})}end(){return new ExpressionWrapper(fe.cloneWith(this.#r.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(fe.cloneWith(this.#r.node,{isStatement:!0}))}}class CaseEndBuilder{#r;constructor(e){this.#r=freeze(e)}end(){return new ExpressionWrapper(fe.cloneWith(this.#r.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(fe.cloneWith(this.#r.node,{isStatement:!0}))}}const me=freeze({is:e=>"JSONPathLegNode"===e.kind,create:(e,r)=>freeze({kind:"JSONPathLegNode",type:e,value:r})});class JSONPathBuilder{#O;constructor(e){this.#O=e}at(e){return this.#S("ArrayLocation",e)}key(e){return this.#S("Member",e)}#S(e,r){return new TraversedJSONPathBuilder(W.cloneWithTraversal(this.#O,b.is(this.#O.traversal)?b.cloneWithLeg(this.#O.traversal,me.create(e,r)):S.cloneWithValue(this.#O.traversal,E.createImmediate(r))))}}class TraversedJSONPathBuilder extends JSONPathBuilder{#O;constructor(e){super(e),this.#O=e}get expressionType(){}as(e){return new AliasedJSONPathBuilder(this,e)}$castTo(){return new JSONPathBuilder(this.#O)}toOperationNode(){return this.#O}}class AliasedJSONPathBuilder{#b;#g;constructor(e,r){this.#b=e,this.#g=r}get expression(){return this.#b}get alias(){return this.#g}toOperationNode(){return t.create(this.#b.toOperationNode(),isOperationNodeSource(this.#g)?this.#g.toOperationNode():e.create(this.#g))}}const Ne=freeze({is:e=>"TupleNode"===e.kind,create:e=>freeze({kind:"TupleNode",values:freeze(e)})});function createExpressionBuilder(e=se){function unary(e,r){return new ExpressionWrapper(function parseUnaryOperation(e,r){return ce.create(y.create(e),parseReferenceExpression(r))}(e,r))}const r=Object.assign((function binary(e,r,t){return new ExpressionWrapper(parseValueBinaryOperation(e,r,t))}),{fn:void 0,eb:void 0,selectFrom:r=>createSelectQueryBuilder({queryId:createQueryId(),executor:e,queryNode:v.createFrom(parseTableExpressionOrList(r))}),selectNoFrom:r=>createSelectQueryBuilder({queryId:createQueryId(),executor:e,queryNode:v.cloneWithSelections(v.create(),parseSelectArg(r))}),case:e=>new CaseBuilder({node:fe.create(isUndefined(e)?void 0:parseReferenceExpression(e))}),ref:(e,r)=>isUndefined(r)?new ExpressionWrapper(parseStringReference(e)):new JSONPathBuilder(function parseJSONReference(e,r){const t=parseStringReference(e);if(isJSONOperator(r))return W.create(t,S.create(y.create(r)));const n=r.slice(0,-1);if(isJSONOperator(n))return W.create(t,b.create(y.create(n)));throw new Error(`Invalid JSON operator: ${r}`)}(e,r)),val:e=>new ExpressionWrapper(parseValueExpressionOrList(e)),refTuple:(...e)=>new ExpressionWrapper(Ne.create(e.map(parseReferenceExpression))),tuple:(...e)=>new ExpressionWrapper(Ne.create(e.map(parseValueExpression))),lit:e=>new ExpressionWrapper(parseSafeImmediateValue(e)),cmpr:(e,r,t)=>new ExpressionWrapper(parseValueBinaryOperation(e,r,t)),bxp:(e,r,t)=>new ExpressionWrapper(parseValueBinaryOperation(e,r,t)),unary:unary,not:e=>unary("not",e),exists:e=>unary("exists",e),neg:e=>unary("-",e),between:(e,r,t)=>new ExpressionWrapper(u.create(parseReferenceExpression(e),y.create("between"),o.create(parseValueExpression(r),parseValueExpression(t)))),betweenSymmetric:(e,r,t)=>new ExpressionWrapper(u.create(parseReferenceExpression(e),y.create("between symmetric"),o.create(parseValueExpression(r),parseValueExpression(t)))),and:e=>isReadonlyArray(e)?new ExpressionWrapper(parseFilterList(e,"and")):new ExpressionWrapper(parseFilterObject(e,"and")),or:e=>isReadonlyArray(e)?new ExpressionWrapper(parseFilterList(e,"or")):new ExpressionWrapper(parseFilterObject(e,"or")),parens(...e){const r=parseValueBinaryOperationOrExpression(e);return C.is(r)?new ExpressionWrapper(r):new ExpressionWrapper(C.create(r))},withSchema:r=>createExpressionBuilder(e.withPluginAtFront(new WithSchemaPlugin(r)))});return r.fn=createFunctionModule(),r.eb=r,r}function expressionBuilder(e){return createExpressionBuilder()}function parseExpression(e){if(isOperationNodeSource(e))return e.toOperationNode();if(isFunction(e))return e(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(e)}`)}function parseAliasedExpression(e){if(isOperationNodeSource(e))return e.toOperationNode();if(isFunction(e))return e(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(e)}`)}function isExpressionOrFactory(e){return isExpression(e)||isAliasedExpression(e)||isFunction(e)}function parseTableExpressionOrList(e){return isReadonlyArray(e)?e.map((e=>parseTableExpression(e))):[parseTableExpression(e)]}function parseTableExpression(r){return isString(r)?function parseAliasedTable(r){const n=" as ";if(r.includes(n)){const[i,o]=r.split(n).map(trim);return t.create(parseTable(i),e.create(o))}return parseTable(r)}(r):parseAliasedExpression(r)}function parseTable(e){if(e.includes(".")){const[r,t]=e.split(".").map(trim);return n.createWithSchema(r,t)}return n.create(e)}function trim(e){return e.trim()}class RawBuilderImpl{#r;constructor(e){this.#r=freeze(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new AliasedRawBuilderImpl(this,e)}$castTo(){return new RawBuilderImpl({...this.#r})}withPlugin(e){return new RawBuilderImpl({...this.#r,plugins:void 0!==this.#r.plugins?freeze([...this.#r.plugins,e]):freeze([e])})}toOperationNode(){return this.#I(this.#z())}compile(e){return this.#E(this.#z(e))}async execute(e){const r=this.#z(e);return r.executeQuery(this.#E(r),this.#r.queryId)}#z(e){const r=void 0!==e?e.getExecutor():se;return void 0!==this.#r.plugins?r.withPlugins(this.#r.plugins):r}#I(e){return e.transformQuery(this.#r.rawNode,this.#r.queryId)}#E(e){return e.compileQuery(this.#I(e),this.#r.queryId)}}function createRawBuilder(e){return new RawBuilderImpl(e)}preventAwait(RawBuilderImpl,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");class AliasedRawBuilderImpl{#C;#g;constructor(e,r){this.#C=e,this.#g=r}get expression(){return this.#C}get alias(){return this.#g}get rawBuilder(){return this.#C}toOperationNode(){return t.create(this.#C.toOperationNode(),isOperationNodeSource(this.#g)?this.#g.toOperationNode():e.create(this.#g))}}preventAwait(AliasedRawBuilderImpl,"don't await AliasedRawBuilder instances directly. AliasedRawBuilder should never be executed directly since it's always a part of another query.");const ye=Object.assign(((e,...r)=>createRawBuilder({queryId:createQueryId(),rawNode:x.create(e,r?.map(parseValueExpression)??[])})),{ref:e=>createRawBuilder({queryId:createQueryId(),rawNode:x.createWithChild(parseStringReference(e))}),val:e=>createRawBuilder({queryId:createQueryId(),rawNode:x.createWithChild(parseValueExpression(e))}),value(e){return this.val(e)},table:e=>createRawBuilder({queryId:createQueryId(),rawNode:x.createWithChild(parseTable(e))}),id(...r){const t=new Array(r.length+1).fill(".");return t[0]="",t[t.length-1]="",createRawBuilder({queryId:createQueryId(),rawNode:x.create(t,r.map(e.create))})},lit:e=>createRawBuilder({queryId:createQueryId(),rawNode:x.createWithChild(E.createImmediate(e))}),literal(e){return this.lit(e)},raw:e=>createRawBuilder({queryId:createQueryId(),rawNode:x.createWithSql(e)}),join(e,r=ye`, `){const t=new Array(2*e.length-1),n=r.toOperationNode();for(let r=0;r<e.length;++r)t[2*r]=parseValueExpression(e[r]),r!==e.length-1&&(t[2*r+1]=n);return createRawBuilder({queryId:createQueryId(),rawNode:x.createWithChildren(t)})}});export{InsertQueryBuilder as $,isNumber as A,isNull as B,w as C,DynamicReferenceBuilder as D,isDate as E,isBigInt as F,getLast as G,ye as H,e as I,isPlainObject as J,compare as K,expressionBuilder as L,logOnce as M,isExpression as N,OperationNodeTransformer as O,C as P,G as Q,x as R,r as S,isAliasedExpression as T,ExpressionWrapper as U,E as V,WithSchemaPlugin as W,AliasedExpressionWrapper as X,OrWrapper as Y,AndWrapper as Z,createSelectQueryBuilder as _,parseStringReference as a,re as a$,UpdateQueryBuilder as a0,DeleteQueryBuilder as a1,NoResultError as a2,isNoResultErrorConstructor as a3,JoinBuilder as a4,InsertResult as a5,DeleteResult as a6,UpdateResult as a7,OnConflictBuilder as a8,OnConflictDoNothingBuilder as a9,X as aA,a as aB,p as aC,l as aD,c as aE,h as aF,f as aG,m as aH,N as aI,isOperator as aJ,isBinaryOperator as aK,isComparisonOperator as aL,isArithmeticOperator as aM,isJSONOperator as aN,s as aO,g as aP,k as aQ,I as aR,B as aS,$ as aT,v as aU,F as aV,n as aW,V as aX,L as aY,he as aZ,M as a_,OnConflictUpdateBuilder as aa,AggregateFunctionBuilder as ab,AliasedAggregateFunctionBuilder as ac,CaseThenBuilder as ad,CaseWhenBuilder as ae,CaseEndBuilder as af,JSONPathBuilder as ag,TraversedJSONPathBuilder as ah,AliasedJSONPathBuilder as ai,createRawBuilder as aj,NoopQueryExecutor as ak,se as al,t as am,o as an,H as ao,ee as ap,_ as aq,j as ar,R as as,de as at,T as au,A as av,d as aw,Z as ax,ae as ay,Y as az,O as b,K as b0,J as b1,pe as b2,Q as b3,q as b4,D as b5,u as b6,ce as b7,P as b8,W as b9,me as ba,b as bb,S as bc,Ne as bd,parseTable as c,parseOrderedColumnName as d,parseValueBinaryOperationOrExpression as e,freeze as f,parseColumnName as g,z as h,isOperationNodeSource as i,createQueryId as j,QueryExecutorBase as k,isFunction as l,isObject as m,noop as n,QueryCreator as o,preventAwait as p,CaseBuilder as q,fe as r,isUndefined as s,parseExpression as t,createFunctionModule as u,U as v,ue as w,isString as x,isBoolean as y,y as z};
